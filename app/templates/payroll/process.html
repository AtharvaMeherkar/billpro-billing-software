{% extends "base.html" %}

{% block title %}Process Payroll{% endblock %}

{% block content %}
<div class="page-header">
    <h1 class="page-title">Process Payroll</h1>
</div>

<form method="post" action="{{ url_for('payroll.process_payroll') }}">
    <div class="card">
        <div class="card-header">Payroll Period</div>
        <div class="card-body">
            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">Month *</label>
                    <select name="month" class="form-control" required>
                        {% for m in range(1, 13) %}
                        <option value="{{ m }}" {% if m == current_month %}selected{% endif %}>
                            {{ ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'][m-1] }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Year *</label>
                    <select name="year" class="form-control" required>
                        {% for y in range(current_year - 1, current_year + 2) %}
                        <option value="{{ y }}" {% if y == current_year %}selected{% endif %}>{{ y }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Total Working Days</label>
                    <input type="number" name="total_days" value="26" class="form-control" min="1" max="31">
                </div>
            </div>
        </div>
    </div>
    
    <div class="card">
        <div class="card-header">Employees ({{ employees|length }})</div>
        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th>
                            <input type="checkbox" id="selectAll" checked onclick="toggleAll(this)">
                        </th>
                        <th>Employee</th>
                        <th>Department</th>
                        <th class="text-right">Basic Salary</th>
                        <th class="text-right">Days Worked</th>
                        <th class="text-right">Bonus</th>
                        <th class="text-right">Loan Deduction</th>
                    </tr>
                </thead>
                <tbody>
                    {% for emp in employees %}
                    <tr>
                        <td>
                            <input type="checkbox" name="employee_ids" value="{{ emp.id }}" checked>
                        </td>
                        <td>
                            <strong>{{ emp.name }}</strong><br>
                            <small class="text-muted">{{ emp.phone or '' }}</small>
                        </td>
                        <td>{{ emp.department or '-' }}</td>
                        <td class="number">â‚¹{{ "%.0f"|format(emp.basic_salary|float) }}</td>
                        <td>
                            <input type="number" name="days_{{ emp.id }}" value="26" class="form-control form-control-sm" style="width: 70px;" min="0" max="31">
                        </td>
                        <td>
                            <input type="number" name="bonus_{{ emp.id }}" value="0" class="form-control form-control-sm" style="width: 80px;" min="0" step="0.01">
                        </td>
                        <td>
                            <input type="number" name="deduction_{{ emp.id }}" value="0" class="form-control form-control-sm" style="width: 80px;" min="0" step="0.01">
                        </td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="7" class="text-center text-muted">No active employees. <a href="{{ url_for('payroll.add_employee') }}">Add Employee</a></td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    
    {% if employees %}
    <div class="form-group">
        <button type="submit" class="btn btn-primary btn-lg">Process Payroll</button>
        <a href="{{ url_for('payroll.index') }}" class="btn btn-secondary btn-lg">Cancel</a>
    </div>
    {% endif %}
</form>

<script>
function toggleAll(source) {
    const checkboxes = document.querySelectorAll('input[name="employee_ids"]');
    checkboxes.forEach(cb => cb.checked = source.checked);
}
</script>
{% endblock %}
