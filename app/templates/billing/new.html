{% extends "base.html" %}

{% block title %}New Invoice{% endblock %}

{% block content %}
<div class="page-header">
    <h1 class="page-title">New Sales Invoice</h1>
</div>

<form method="post" action="{{ url_for('billing.create') }}" id="invoice-form">
    <div class="card">
        <div class="card-header">Invoice Details</div>
        <div class="card-body">
            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">Invoice Date *</label>
                    <input type="date" name="invoice_date" value="{{ today }}" class="form-control" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Customer *</label>
                    <select name="party_id" class="form-control" required id="customer-select">
                        <option value="">Select Customer</option>
                        {% for c in customers %}
                        <option value="{{ c.id }}" data-gstin="{{ c.gstin }}" data-state="{{ c.state_code }}">
                            {{ c.name }} {% if c.gstin %}({{ c.gstin }}){% endif %}
                        </option>
                        {% endfor %}
                    </select>
                    <small><a href="{{ url_for('ledgers.add') }}?type=customer" target="_blank">+ Add New Customer</a></small>
                </div>
                <div class="form-group">
                    <label class="form-label">Payment Mode *</label>
                    <select name="payment_mode" class="form-control" required>
                        <option value="CASH">Cash</option>
                        <option value="BANK">Bank Transfer</option>
                        <option value="CREDIT">Credit (On Account)</option>
                    </select>
                </div>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label class="form-check">
                        <input type="checkbox" name="is_gst_invoice" id="is_gst_invoice" checked onchange="InvoiceForm.calculateTotals()">
                        GST Invoice
                    </label>
                </div>
            </div>
        </div>
    </div>
    
    <div class="card">
        <div class="card-header">
            Invoice Items
            <button type="button" class="btn btn-sm btn-primary" onclick="InvoiceForm.addItem()" style="float: right;">+ Add Item</button>
        </div>
        <div class="card-body">
            <table class="invoice-items-table">
                <thead>
                    <tr>
                        <th style="width: 30%;">Product</th>
                        <th style="width: 10%;">HSN</th>
                        <th style="width: 10%;">Qty</th>
                        <th style="width: 12%;">Rate</th>
                        <th style="width: 8%;">Disc %</th>
                        <th style="width: 8%;">GST</th>
                        <th style="width: 12%;">Amount</th>
                        <th style="width: 5%;"></th>
                    </tr>
                </thead>
                <tbody id="invoice-items">
                    <!-- Items added dynamically -->
                </tbody>
            </table>
            
            <div class="invoice-totals">
                <table class="invoice-totals-table">
                    <tr>
                        <td>Subtotal:</td>
                        <td class="text-right">₹<span id="subtotal">0.00</span></td>
                    </tr>
                    <tr id="cgst-row">
                        <td>CGST:</td>
                        <td class="text-right">₹<span id="cgst-total">0.00</span></td>
                    </tr>
                    <tr id="sgst-row">
                        <td>SGST:</td>
                        <td class="text-right">₹<span id="sgst-total">0.00</span></td>
                    </tr>
                    <tr id="igst-row" style="display: none;">
                        <td>IGST:</td>
                        <td class="text-right">₹<span id="igst-total">0.00</span></td>
                    </tr>
                    <tr>
                        <td>Round Off:</td>
                        <td class="text-right">₹<span id="round-off">0.00</span></td>
                    </tr>
                    <tr class="total-row">
                        <td><strong>Grand Total:</strong></td>
                        <td class="text-right"><strong>₹<span id="grand-total">0.00</span></strong></td>
                    </tr>
                </table>
            </div>
        </div>
    </div>
    
    <div class="card">
        <div class="card-body">
            <div class="form-group">
                <label class="form-label">Notes (Optional)</label>
                <textarea name="notes" class="form-control" rows="2"></textarea>
            </div>
        </div>
    </div>
    
    <div class="form-group">
        <button type="submit" class="btn btn-primary btn-lg">Create Invoice</button>
        <a href="{{ url_for('billing.index') }}" class="btn btn-secondary btn-lg">Cancel</a>
    </div>
</form>

<!-- Product data for JS -->
<script>
    const productsData = [
        {% for p in products %}
        {
            id: {{ p.id }},
            name: "{{ p.name|e }}",
            code: "{{ p.code or ''|e }}",
            hsn: "{{ p.hsn_code or ''|e }}",
            gst: {{ p.gst_percent|float }},
            price: {{ p.selling_price|float }},
            stock: {{ p.current_stock|float }},
            unit: "{{ p.unit|e }}"
        }{% if not loop.last %},{% endif %}
        {% endfor %}
    ];
</script>
{% endblock %}

{% block scripts %}
<script>
    // Override populateProducts to use server-rendered data
    InvoiceForm.populateProducts = function(select) {
        productsData.forEach(p => {
            const option = document.createElement('option');
            option.value = p.id;
            option.textContent = `${p.name} ${p.code ? '(' + p.code + ')' : ''} - Stock: ${p.stock}`;
            option.dataset.price = p.price;
            option.dataset.gst = p.gst;
            option.dataset.hsn = p.hsn;
            select.appendChild(option);
        });
    };
    
    // Add first item on load
    document.addEventListener('DOMContentLoaded', function() {
        InvoiceForm.addItem();
    });
</script>
{% endblock %}
